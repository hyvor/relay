#!/usr/bin/env bash

set -euo pipefail

replace_var() {
    local file="$1"
    local var="$2"
    local value="$3"

    # Use sed to replace variables like $VAR or VAR=
    if grep -q "$var" "$file"; then
        sed -i "s|\${$var}|$value|g;" "$file"
    fi
}

echo "üîê Generating random keys and updating environment files..."

# Generate app secret
APP_SECRET=$(openssl rand -base64 32)
replace_var ".env" "APP_SECRET" "$APP_SECRET"
echo "‚úÖ Updated APP_SECRET in .env"

# Generate PostgreSQL password
PGSQL_PASSWORD=$(openssl rand -base64 32)
replace_var ".env" "PGSQL_PASSWORD" "$PGSQL_PASSWORD"
replace_var "compose.yaml" "PGSQL_PASSWORD" "$PGSQL_PASSWORD"
echo "‚úÖ Updated PGSQL_PASSWORD in .env and compose.yaml"

# Prompt for OIDC configuration
read -rp "Enter OIDC Issuer URL: " OIDC_ISSUER_URL
replace_var ".env" "OIDC_ISSUER_URL" "$OIDC_ISSUER_URL"

read -rp "Enter OIDC Client ID: " OIDC_CLIENT_ID
replace_var ".env" "OIDC_CLIENT_ID" "$OIDC_CLIENT_ID"

read -rp "Enter OIDC Client Secret: " OIDC_CLIENT_SECRET
replace_var ".env" "OIDC_CLIENT_SECRET" "$OIDC_CLIENT_SECRET"

echo "‚úÖ OIDC values updated in .env"
echo "üéâ All done! Your .env and compose.yaml have been updated. Verify the changes and start your services."